# etcd Role in Kubernetes

## What is etcd?

**etcd** is a distributed, strongly consistent **key–value store** used by Kubernetes as its **single source of truth**.

It stores **all cluster state and metadata** so every Kubernetes component has a consistent view of the cluster.

> If etcd data is lost and no backup exists, the Kubernetes cluster state is lost.

---

## Core Rule (Most Important)

> **A Kubernetes object is considered created the moment the API Server successfully writes it to etcd.**

Nothing runs before this write. Everything reacts after it.

---

## Who Talks to etcd?

Only **one component** communicates directly with etcd:

* ✅ **kube-apiserver**

All other components (controllers, scheduler, kubelet, kubectl):

* ❌ Do NOT talk to etcd directly
* ✅ Talk to the **API Server**, which then updates etcd

---

## etcd Role in Deployment Creation (3 Replicas)

### Step-by-Step Flow

```
kubectl
   ↓
API Server (AuthN, AuthZ, Admission)
   ↓
etcd (stores Deployment)
   ↓
Deployment Controller → API Server → etcd (ReplicaSet)
   ↓
ReplicaSet Controller → API Server → etcd (Pods)
   ↓
Scheduler → API Server → etcd (nodeName update)
   ↓
Kubelet → API Server → etcd (status update)
```

---

## What etcd Stores at Each Stage

### 1. Deployment Created

```
/registry/deployments/default/nginx-deployment
```

* Deployment exists
* No ReplicaSet
* No Pods

---

### 2. ReplicaSet Created

```
/registry/replicasets/default/nginx-deployment-xxxx
```

* Desired replicas = 3
* Still no Pods

---

### 3. Pods Created (Pending)

```
/registry/pods/default/nginx-abc1
/registry/pods/default/nginx-abc2
/registry/pods/default/nginx-abc3
```

* Pods created
* No node assigned yet

---

### 4. Pods Scheduled (Update)

```
spec.nodeName = worker-node-1
```

* Existing Pod entries updated
* No new objects created

---

### 5. Pods Running (Status Update)

```
status.phase = Running
```

* Kubelet reports status
* API Server updates etcd

---

## Feedback Loop (Critical Concept)

* Controllers **WATCH** objects via API Server
* Compare **desired state vs current state**
* Send **write requests back to API Server**
* API Server updates etcd

> **Controllers never write to etcd directly.**

---

## What etcd Stores

* Deployments, ReplicaSets, Pods
* Services, ConfigMaps, Secrets
* Nodes, Namespaces
* RBAC objects

---

## What etcd Does NOT Store

* Container images
* Application logs
* Metrics
* PersistentVolume data

Only **metadata and cluster state**.

---

## One-Line Interview Answer

> **etcd stores the complete desired and current state of a Kubernetes cluster. All objects are created when the API Server persists them in etcd, and controllers continuously reconcile reality to match that stored state.**
