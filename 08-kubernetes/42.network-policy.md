# NetworkPolicy in Kubernetes

## What is a NetworkPolicy?

A **NetworkPolicy** is a Kubernetes resource used to **control network traffic between Pods and/or external endpoints** at the IP address or port level.

In simple terms:

* It acts like a **firewall for Pods**
* It defines **who can talk to whom**, and **on which ports**

NetworkPolicies are implemented by the **Container Network Interface (CNI)** plugin (like Calico, Cilium, Weave). If the CNI does not support NetworkPolicy, these rules do nothing.

---

## Default Network Behavior (Without NetworkPolicy)

By default, Kubernetes networking follows an **open network model**.

### Default Rules

* All Pods can communicate with **all other Pods** across namespaces
* All inbound traffic to Pods is **allowed**
* All outbound traffic from Pods is **allowed**
* No network isolation exists by default

### Example (No NetworkPolicy)

```
Pod A (frontend)  ---> Pod B (backend)   ✅ Allowed
Pod A (frontend)  ---> Pod C (database)  ✅ Allowed
Any Pod           ---> Any Pod           ✅ Allowed
```

This is convenient for development but **unsafe for production**.

---

## Why NetworkPolicy is Needed

Without NetworkPolicy:

* A compromised Pod can talk to **any other Pod**
* No isolation between frontend, backend, and database
* Hard to enforce **Zero Trust networking**

With NetworkPolicy:

* You explicitly allow required traffic
* Everything else is **denied by default**

---

## How NetworkPolicy Works

A NetworkPolicy:

* Selects Pods using **labels**
* Defines rules for:

  * **Ingress** (incoming traffic)
  * **Egress** (outgoing traffic)
* Rules are **additive** (multiple policies can apply)

Important:

> Traffic is only restricted **after a Pod is selected by a NetworkPolicy**

---

## Key Components of NetworkPolicy

| Field       | Purpose                       |
| ----------- | ----------------------------- |
| podSelector | Selects target Pods           |
| policyTypes | Ingress / Egress              |
| ingress     | Allowed incoming traffic      |
| egress      | Allowed outgoing traffic      |
| from / to   | Traffic source or destination |
| ports       | Allowed ports                 |

---

## Example Scenario

### Setup

* Namespace: `app`
* Pods:

  * frontend (label: app=frontend)
  * backend (label: app=backend)
  * database (label: app=db)

Goal:

* Frontend ➜ Backend ✅
* Backend ➜ Database ✅
* Frontend ➜ Database ❌

---

## Step 1: Default Deny All Ingress

```
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: app
spec:
  podSelector: {}
  policyTypes:
  - Ingress
```

### Effect

* Blocks **all incoming traffic** to all Pods in namespace
* Outgoing traffic still allowed

---

## Step 2: Allow Frontend ➜ Backend

```
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-frontend-to-backend
  namespace: app
spec:
  podSelector:
    matchLabels:
      app: backend
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: frontend
    ports:
    - protocol: TCP
      port: 8080
```

### Effect

* Only frontend Pods can access backend on port 8080

---

## Step 3: Allow Backend ➜ Database

```
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-backend-to-db
  namespace: app
spec:
  podSelector:
    matchLabels:
      app: db
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: backend
    ports:
    - protocol: TCP
      port: 5432
```

### Effect

* Only backend Pods can talk to database on port 5432

---

## Egress NetworkPolicy Example

Allow backend Pods to access external APIs only on HTTPS.

```
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-backend-egress-https
  namespace: app
spec:
  podSelector:
    matchLabels:
      app: backend
  policyTypes:
  - Egress
  egress:
  - to:
    - ipBlock:
        cidr: 0.0.0.0/0
    ports:
    - protocol: TCP
      port: 443
```

---

## Important Notes

* NetworkPolicy works at **Layer 3/4** (IP + Port)
* It does **not** inspect HTTP paths or headers
* Policies are namespace-scoped
* If no NetworkPolicy selects a Pod → traffic is unrestricted

---

## Summary

* NetworkPolicy controls Pod-to-Pod and Pod-to-external traffic
* Default Kubernetes networking is **allow-all**
* NetworkPolicy enables **secure, least-privilege networking**
* Always start with **default deny**, then allow required traffic

---

## One-Line Definition

> NetworkPolicy is a Kubernetes firewall mechanism that defines how Pods are allowed to communicate with each other and external services.
